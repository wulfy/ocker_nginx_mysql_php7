daemon off;
 
user  nginx;
worker_processes  1;
 
error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;
 
 
events {
    worker_connections  1024;
}
 
 
http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
 
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';
 
    access_log  /var/log/nginx/access.log  main;
 
    sendfile        on;
    #tcp_nopush     on;
 
    keepalive_timeout  65;
 
    #gzip  on;

    #rive lamartine SF
    server {
        listen       8080;
        server_name  localhost rive-lamartine.fr www.rive-lamartine.fr;
        root /usr/share/nginx/html/rive_lamartine_sf/web;

        location / {
            # try to serve file directly, fallback to app.php
            try_files $uri /app.php$is_args$args;
        }

        # DEV
        # This rule should only be placed on your development environment
        # In production, don't include this and don't deploy app_dev.php or config.php
        location ~ ^/(app_dev|config)\.php(/|$) {
            include /usr/share/nginx/html/docker_nginx_mysql_php7/nginx/php_proxy.conf;
        }
        # PROD
        location ~ ^/app\.php(/|$) {
            include /usr/share/nginx/html/docker_nginx_mysql_php7/nginx/php_proxy.conf;
            
            # Prevents URIs that include the front controller. This will 404:
            # http://domain.tld/app.php/some-path
            # Remove the internal directive to allow URIs like this
            internal;
        }

        # return 404 for all other php files not matching the front controller
        # this prevents access to other php files you don't want to be accessible.
        location ~ \.php$ {
          return 404;
        }

        location @rewriteapp {
            rewrite ^(.*)$ /app_dev.php/$1 last;
        }

        error_log /var/log/nginx/project_error.log;
        access_log /var/log/nginx/project_access.log;
    }

    #lmsecuritecom
    server {
        listen       80;
        root /usr/share/nginx/html/wordpress/;
        server_name  localhost lmsecurite.com www.lmsecurite.com;

        location / {
            index index.php index.html index.htm;
            # try to serve file directly, fallback to app.php
            try_files $uri $uri/ =404;
        }

        # Pass PHP scripts to PHP-FPM
        location ~* \.php$ {
            include /usr/share/nginx/html/docker_nginx_mysql_php7/nginx/php_proxy.conf;
        }    

        #!!! IMPORTANT !!! We need to hide the password file from prying eyes
        # This will deny access to any hidden file (beginning with a .period)
        location ~ /\. { deny  all; }


        error_log /var/log/nginx/lmsecurite_error.log;
        access_log /var/log/nginx/lmsecurite_access.log;


    }

    #all other sites
    server {
        listen       91;
        #server_name  localhost;
        root /usr/share/nginx/html;

        location ^~ /docker_nginx_mysql_php7/ {
           
            auth_basic "Restricted"; 
        }

        location ^~ /coffre-fort/ {
           
            auth_basic "Restricted";                                #For Basic Auth
            auth_basic_user_file /usr/share/nginx/html/coffre-fort/.htpasswd;  #For Basic Auth

            location ~* \.php$ {
                include /usr/share/nginx/html/docker_nginx_mysql_php7/nginx/php_proxy.conf;
            }    
        }


        location / {
            index index.php index.html index.htm;
            # try to serve file directly, fallback to app.php
            try_files $uri $uri/ =404;
        }

        location /nginx_status {
            stub_status on;
            access_log off;
            allow 172.19.0.1;
            deny all;
        }
        
         # Pass PHP scripts to PHP-FPM
        location ~* \.php$ {
            include /usr/share/nginx/html/docker_nginx_mysql_php7/nginx/php_proxy.conf;
        }    

        #!!! IMPORTANT !!! We need to hide the password file from prying eyes
        # This will deny access to any hidden file (beginning with a .period)
        location ~ /\. { deny  all; }


        error_log /var/log/nginx/default_error.log;
        access_log /var/log/nginx/default_access.log;
    }
    
 
}
